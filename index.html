<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Quản Lý Sức Khỏe</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        // Global variables for Firebase
        let app, auth, db;
        const firebaseConfig = {
            apiKey: "AIzaSyBLc2DYfVdxHdUDQhY9UrX0XlDuXH_NO7Q",
            authDomain: "suckhoe-4777a.firebaseapp.com",
            projectId: "suckhoe-4777a",
            storageBucket: "suckhoe-4777a.firebasestorage.app",
            messagingSenderId: "752106860226",
            appId: "1:752106860226:web:a245b5daedab3b0aca155b",
            measurementId: "G-38JCCTKRGM"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            updatePassword, 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            doc, 
            updateDoc, 
            deleteDoc,
            query,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase on window load
        window.onload = () => {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Listen to auth state changes
            onAuthStateChanged(auth, handleAuthStateChange);
        };
        
        // --- UI Elements ---
        const loginForm = document.getElementById('login-form');
        const mainContent = document.getElementById('main-content');
        const mainHeader = document.getElementById('main-header'); // Thêm tham chiếu đến header
        const loginErrorMsg = document.getElementById('login-error-msg');
        const userEmailDisplay = document.getElementById('user-email-display');
        const profileList = document.getElementById('profile-list');
        const healthDataSection = document.getElementById('health-data-section');
        const healthDataList = document.getElementById('health-data-list');
        const healthDataForm = document.getElementById('health-data-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const chartsSection = document.getElementById('charts-section');

        // All modals and dialogs
        const messageBox = document.getElementById('message-box');
        const changePasswordModal = document.getElementById('change-password-modal');
        const addAccountModal = document.getElementById('add-account-modal');
        const profileModal = document.getElementById('profile-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        let profileToDeleteId = null;
        let currentProfileId = null;

        // Chart instances
        let bpChartInstance, heartRateChartInstance, sleepChartInstance, stepsChartInstance, weightChartInstance;

        // --- Helper Functions ---
        function showLoading(show = true) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        function showMessage(msg) {
            document.getElementById('message-content').textContent = msg;
            messageBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Authentication Logic ---
        function handleAuthStateChange(user) {
            showLoading(false);
            if (user) {
                // If user is logged in, hide login form and show header + main content
                loginForm.classList.add('hidden');
                mainHeader.classList.remove('hidden'); 
                mainContent.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;

                // Show admin button for a specific user
                if (user.email === 'admin@myapp.com') {
                    document.getElementById('add-user-btn').classList.remove('hidden');
                } else {
                    document.getElementById('add-user-btn').classList.add('hidden');
                }

                listenForProfiles();
            } else {
                // If user is logged out, show login form and hide header + main content
                loginForm.classList.remove('hidden');
                mainHeader.classList.add('hidden');
                mainContent.classList.add('hidden');
                document.getElementById('login-password').value = '';
                profileList.innerHTML = '';
                healthDataSection.classList.add('hidden');
            }
        }

        // Event listener for login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginErrorMsg.textContent = '';
            showLoading();
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginErrorMsg.textContent = "Đăng nhập thất bại. Vui lòng kiểm tra lại email và mật khẩu.";
                console.error("Login failed:", error);
            } finally {
                showLoading(false);
            }
        });

        // Event listener for logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            showLoading();
            try {
                await signOut(auth);
            } catch (error) {
                showMessage("Đăng xuất thất bại. Vui lòng thử lại.");
                console.error("Logout failed:", error);
            } finally {
                showLoading(false);
            }
        });

        // Event listener for adding new user (Admin function)
        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('add-account-modal').classList.remove('hidden');
        });

        document.getElementById('confirm-add-account').addEventListener('click', async () => {
            const newEmail = document.getElementById('new-email-input').value;
            const newPassword = document.getElementById('new-password-add-input').value;

            if (newEmail && newPassword.length >= 6) {
                hideModal('add-account-modal');
                showLoading();
                try {
                    await createUserWithEmailAndPassword(auth, newEmail, newPassword);
                    showMessage("Tài khoản mới đã được thêm thành công!");
                } catch (error) {
                    showMessage("Tạo tài khoản thất bại. Vui lòng kiểm tra email hoặc thử lại.");
                    console.error("Create user failed:", error);
                } finally {
                    showLoading(false);
                }
            } else {
                showMessage("Vui lòng nhập email hợp lệ và mật khẩu ít nhất 6 ký tự.");
            }
        });

        // --- Profile Management Logic ---
        document.getElementById('add-profile-btn').addEventListener('click', () => {
            document.getElementById('profile-modal-title').textContent = "Thêm Hồ Sơ Mới";
            document.getElementById('profile-form').reset();
            document.getElementById('profile-id').value = '';
            profileModal.classList.remove('hidden');
        });

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const profileId = document.getElementById('profile-id').value;
            const user = auth.currentUser;
            if (!user) {
                showMessage("Bạn cần phải đăng nhập để lưu hồ sơ.");
                return;
            }

            const profileData = {
                name: document.getElementById('profile-name').value,
                age: document.getElementById('profile-age').value,
                address: document.getElementById('profile-address').value,
                notes: document.getElementById('profile-note').value,
                userId: user.uid,
                creatorEmail: user.email // Lấy email của người tạo hồ sơ
            };

            showLoading();
            try {
                if (profileId) {
                    await updateDoc(doc(db, 'profiles', profileId), profileData);
                    showMessage("Hồ sơ đã được cập nhật!");
                } else {
                    await addDoc(collection(db, 'profiles'), { ...profileData, createdAt: new Date() });
                    showMessage("Hồ sơ mới đã được lưu thành công!");
                }
                hideModal('profile-modal');
            } catch (error) {
                showMessage("Lưu hồ sơ thất bại. Vui lòng thử lại.");
                console.error("Save profile failed:", error);
            } finally {
                showLoading(false);
            }
        });

        function renderProfiles(profiles) {
            profileList.innerHTML = '';
            if (profiles.length === 0) {
                profileList.innerHTML = '<p class="text-gray-500 text-center w-full">Chưa có hồ sơ nào. Hãy thêm hồ sơ mới!</p>';
                return;
            }

            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'flex-shrink-0 bg-white p-6 rounded-xl shadow-md flex flex-col justify-between w-full sm:w-64 min-h-64 cursor-pointer hover:shadow-lg transition-shadow duration-300';
                profileCard.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-indigo-600 mb-2">${profile.name}</h3>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p><strong>Tuổi:</strong> ${profile.age}</p>
                            <p><strong>Nơi ở:</strong> ${profile.address}</p>
                            <p><strong>Ghi chú:</strong> ${profile.notes}</p>
                            <p><strong>Tạo bởi:</strong> ${profile.creatorEmail || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button data-id="${profile.id}" class="view-btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition duration-300 focus:outline-none"><i class="fas fa-eye"></i></button>
                        <button data-id="${profile.id}" class="edit-btn bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition duration-300 focus:outline-none"><i class="fas fa-edit"></i></button>
                        <button data-id="${profile.id}" class="delete-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition duration-300 focus:outline-none"><i class="fas fa-trash-alt"></i></button>
			<button data-id="${profile.id}" class="export-pdf-btn bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition duration-300"><i class="fas fa-file-export"></i></button>
                    </div>
                `;
                profileList.appendChild(profileCard);
            });
            
            // Attach event listeners to the profile list container using event delegation
            profileList.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('button');
                if (!targetBtn) return;
                const profileId = targetBtn.dataset.id;
                
                if (targetBtn.classList.contains('view-btn')) {
                    currentProfileId = profileId;
                    healthDataSection.classList.remove('hidden');
                    listenForHealthData(currentProfileId);
                    healthDataSection.scrollIntoView({ behavior: 'smooth' });
                } else if (targetBtn.classList.contains('edit-btn')) {
                    const profileToEdit = profiles.find(p => p.id === profileId);
                    document.getElementById('profile-modal-title').textContent = "Sửa Hồ Sơ";
                    document.getElementById('profile-id').value = profileToEdit.id;
                    document.getElementById('profile-name').value = profileToEdit.name;
                    document.getElementById('profile-age').value = profileToEdit.age;
                    document.getElementById('profile-address').value = profileToEdit.address;
                    document.getElementById('profile-note').value = profileToEdit.notes;
                    profileModal.classList.remove('hidden');
                } else if (targetBtn.classList.contains('delete-btn')) {
                    profileToDeleteId = profileId;
                    deleteConfirmModal.classList.remove('hidden');
               } else if (targetBtn.classList.contains('export-pdf-btn')) {
    		    const profileToExport = profiles.find(p => p.id === profileId);

                  // Hiển thị dữ liệu và vẽ chart trước
                    currentProfileId = profileToExport.id;
                    healthDataSection.classList.remove('hidden');
                    listenForHealthData(currentProfileId);

                  // Đợi 500ms cho Chart.js render xong rồi mới export
                 setTimeout(() => {
                   exportProfileToPDF(profileToExport);
                }, 500);
                }


            });
        }

        // Real-time listener for profiles
        function listenForProfiles() {
            const user = auth.currentUser;
            if (!user) return;
            
            let q;
            if (user.email === 'admin@myapp.com') {
                q = collection(db, 'profiles');
            } else {
                q = query(collection(db, 'profiles'), where("userId", "==", user.uid));
            }

            onSnapshot(q, (querySnapshot) => {
                const profiles = [];
                querySnapshot.forEach((doc) => {
                    profiles.push({ id: doc.id, ...doc.data() });
                });
                renderProfiles(profiles);
            }, (error) => {
                console.error("Lỗi khi lấy dữ liệu hồ sơ:", error);
                //showMessage("Không thể tải dữ liệu hồ sơ.");
            });
        }

        // Delete confirmation
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            hideModal('delete-confirm-modal');
            if (profileToDeleteId) {
                showLoading();
                try {
                    // Bước 1: Tìm tất cả các bản ghi sức khỏe liên quan
                    const healthRecordsQuery = query(collection(db, 'healthRecords'), where("profileId", "==", profileToDeleteId));
                    const healthRecordsSnapshot = await getDocs(healthRecordsQuery);

                    // Bước 2: Xóa từng bản ghi sức khỏe
                    const deletionPromises = [];
                    healthRecordsSnapshot.forEach(doc => {
                        deletionPromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletionPromises);

                    // Bước 3: Xóa hồ sơ chính
                    await deleteDoc(doc(db, 'profiles', profileToDeleteId));

                    showMessage("Hồ sơ và tất cả dữ liệu liên quan đã được xóa!");
                } catch (error) {
                    showMessage("Xóa hồ sơ thất bại.");
                    console.error("Delete profile failed:", error);
                } finally {
                    showLoading(false);
                    profileToDeleteId = null;
                }
            }
        });

        // --- Health Data Logic ---
        document.getElementById('close-health-data-btn').addEventListener('click', () => {
            healthDataSection.classList.add('hidden');
            healthDataForm.reset();
            healthDataList.innerHTML = '';
            chartsSection.classList.add('hidden');
            currentProfileId = null;
            // Destroy all charts when closing
            if (bpChartInstance) bpChartInstance.destroy();
            if (heartRateChartInstance) heartRateChartInstance.destroy();
            if (sleepChartInstance) sleepChartInstance.destroy();
            if (stepsChartInstance) stepsChartInstance.destroy();
            if (weightChartInstance) weightChartInstance.destroy();
        });

        healthDataForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentProfileId) {
                showMessage("Vui lòng chọn một hồ sơ trước.");
                return;
            }

            const healthData = {
                date: document.getElementById('health-date').value,
                weight: parseFloat(document.getElementById('health-weight').value) || null,
                bloodPressure: document.getElementById('health-bp').value,
                heartRate: parseInt(document.getElementById('health-heart-rate').value) || null,
                sleep: parseFloat(document.getElementById('health-sleep').value) || null,
                steps: parseInt(document.getElementById('health-steps').value) || null,
                notes: document.getElementById('health-note').value,
                profileId: currentProfileId,
                createdAt: new Date()
            };

            showLoading();
            try {
                await addDoc(collection(db, 'healthRecords'), healthData);
                showMessage("Dữ liệu sức khỏe đã được lưu thành công!");
                healthDataForm.reset();
            } catch (error) {
                showMessage("Lưu dữ liệu sức khỏe thất bại.");
                console.error("Save health data failed:", error);
            } finally {
                showLoading(false);
            }
        });
        
        function listenForHealthData(profileId) {
            const q = query(collection(db, 'healthRecords'), where("profileId", "==", profileId));
            onSnapshot(q, (querySnapshot) => {
                const records = [];
                querySnapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                renderHealthData(records);
            }, (error) => {
                console.error("Lỗi khi lấy dữ liệu sức khỏe:", error);
                //showMessage("Không thể tải dữ liệu sức khỏe.");
            });
        }

        function renderHealthData(records) {
            // Xóa nội dung danh sách cũ
            healthDataList.innerHTML = '';
            chartsSection.classList.add('hidden');

            if (records.length === 0) {
                healthDataList.innerHTML = '<p class="text-gray-500 text-center">Chưa có dữ liệu sức khỏe nào. Hãy thêm dữ liệu mới!</p>';
                // Destroy existing charts if there is no data
                if (bpChartInstance) bpChartInstance.destroy();
                if (heartRateChartInstance) heartRateChartInstance.destroy();
                if (sleepChartInstance) sleepChartInstance.destroy();
                if (stepsChartInstance) stepsChartInstance.destroy();
                if (weightChartInstance) weightChartInstance.destroy();
                return;
            }

            // Sắp xếp dữ liệu theo ngày gần nhất
            records.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            // Render danh sách dữ liệu
            records.forEach(record => {
                const date = record.date ? new Date(record.date).toLocaleDateString('vi-VN') : 'N/A';
                const recordElement = document.createElement('div');
                recordElement.className = 'bg-white p-4 rounded-xl shadow-md mb-3';
                recordElement.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-sm text-gray-700">
                        <p><i class="fas fa-calendar-alt mr-2 text-indigo-500"></i><strong>Ngày:</strong> ${date}</p>
                        <p><i class="fas fa-weight-hanging mr-2 text-indigo-500"></i><strong>Cân nặng:</strong> ${record.weight || 'N/A'} kg</p>
                        <p><i class="fas fa-heartbeat mr-2 text-indigo-500"></i><strong>Huyết áp:</strong> ${record.bloodPressure || 'N/A'}</p>
                        <p><i class="fas fa-tachometer-alt mr-2 text-indigo-500"></i><strong>Nhịp tim:</strong> ${record.heartRate || 'N/A'} bpm</p>
                        <p><i class="fas fa-bed mr-2 text-indigo-500"></i><strong>Giấc ngủ:</strong> ${record.sleep || 'N/A'} giờ</p>
                        <p><i class="fas fa-shoe-prints mr-2 text-indigo-500"></i><strong>Bước chân:</strong> ${record.steps || 'N/A'}</p>
                    </div>
                    <p class="text-sm text-gray-700 mt-2"><strong>Ghi chú:</strong> ${record.notes || 'Không có'}</p>
                `;
                healthDataList.appendChild(recordElement);
            });

            // Sau khi render danh sách, tiến hành vẽ biểu đồ
            renderCharts(records);
        }

        function renderCharts(records) {
            if (records.length < 2) {
                chartsSection.classList.add('hidden');
                return;
            }
            chartsSection.classList.remove('hidden');

            // Hủy các biểu đồ cũ để vẽ lại
            if (bpChartInstance) bpChartInstance.destroy();
            if (heartRateChartInstance) heartRateChartInstance.destroy();
            if (sleepChartInstance) sleepChartInstance.destroy();
            if (stepsChartInstance) stepsChartInstance.destroy();
            if (weightChartInstance) weightChartInstance.destroy();

            // Sắp xếp dữ liệu theo ngày tăng dần để vẽ biểu đồ
            records.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Chuẩn bị dữ liệu cho biểu đồ
            const dates = records.map(r => r.date ? new Date(r.date).toLocaleDateString('vi-VN') : 'N/A');
            
            const systolicData = records.map(r => r.bloodPressure ? parseInt(r.bloodPressure.split('/')[0]) : null);
            const diastolicData = records.map(r => r.bloodPressure ? parseInt(r.bloodPressure.split('/')[1]) : null);
            const heartRateData = records.map(r => r.heartRate);
            const sleepData = records.map(r => r.sleep);
            const stepsData = records.map(r => r.steps);
            const weightData = records.map(r => r.weight);
            
            // Vẽ biểu đồ Cân nặng
            const weightCtx = document.getElementById('weightChart').getContext('2d');
            weightChartInstance = new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Cân nặng (kg)',
                        data: weightData,
                        borderColor: 'rgb(255, 159, 64)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: 'Biểu đồ Cân nặng', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // Vẽ biểu đồ Huyết áp
            const bpCtx = document.getElementById('bpChart').getContext('2d');
            bpChartInstance = new Chart(bpCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Tâm thu (Systolic)',
                        data: systolicData,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }, {
                        label: 'Tâm trương (Diastolic)',
                        data: diastolicData,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Biểu đồ Huyết áp', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // Vẽ biểu đồ Nhịp tim
            const heartRateCtx = document.getElementById('heartRateChart').getContext('2d');
            heartRateChartInstance = new Chart(heartRateCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Nhịp tim (bpm)',
                        data: heartRateData,
                        borderColor: 'rgb(54, 162, 235)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Biểu đồ Nhịp tim', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // Vẽ biểu đồ Giấc ngủ
            const sleepCtx = document.getElementById('sleepChart').getContext('2d');
            sleepChartInstance = new Chart(sleepCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Giấc ngủ (giờ)',
                        data: sleepData,
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Biểu đồ Giấc ngủ', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // Vẽ biểu đồ Bước chân
            const stepsCtx = document.getElementById('stepsChart').getContext('2d');
            stepsChartInstance = new Chart(stepsCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Bước chân',
                        data: stepsData,
                        borderColor: 'rgb(255, 159, 64)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Biểu đồ Bước chân', font: { size: 16 } }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        // --- Event Listeners for Modals ---
        document.getElementById('change-password-btn').addEventListener('click', () => {
            changePasswordModal.classList.remove('hidden');
        });
        document.getElementById('confirm-change-password').addEventListener('click', async () => {
            const newPassword = document.getElementById('new-password-input').value;
            if (newPassword.length >= 6) {
                hideModal('change-password-modal');
                showLoading();
                try {
                    await updatePassword(auth.currentUser, newPassword);
                    showMessage("Mật khẩu đã được đổi thành công!");
                } catch (error) {
                    showMessage("Thay đổi mật khẩu thất bại. Vui lòng thử lại sau.");
                    console.error("Change password failed:", error);
                } finally {
                    showLoading(false);
                }
            } else {
                showMessage("Mật khẩu phải có ít nhất 6 ký tự.");
            }
        });

        // Event listeners to close all modals
        document.getElementById('message-close-btn').addEventListener('click', hideMessageBox);
        document.getElementById('cancel-change-password').addEventListener('click', () => hideModal('change-password-modal'));
        document.getElementById('cancel-add-account').addEventListener('click', () => hideModal('add-account-modal'));
        document.getElementById('cancel-profile-btn').addEventListener('click', () => hideModal('profile-modal'));
        document.getElementById('cancel-delete-btn').addEventListener('click', () => hideModal('delete-confirm-modal'));

async function exportProfileToPDF(profile) {
    try {
        showLoading(true);

        // 1. Lấy dữ liệu healthRecords từ Firestore
        const q = query(collection(db, 'healthRecords'), where("profileId", "==", profile.id));
        const querySnapshot = await getDocs(q);

        const healthRecords = [];
        querySnapshot.forEach(doc => {
            healthRecords.push({ id: doc.id, ...doc.data() });
        });

        // Sắp xếp theo ngày
        healthRecords.sort((a, b) => new Date(a.date) - new Date(b.date));

        // 2. Tạo nội dung text trước
        const content = [
            { text: 'HỒ SƠ NGƯỜI DÙNG', style: 'header' },
            { text: `Họ tên: ${profile.name}\nTuổi: ${profile.age}\nĐịa chỉ: ${profile.address}\nGhi chú: ${profile.notes || 'Không có'}\nNgười tạo: ${profile.creatorEmail}\n\n`, style: 'subheader' },
            { text: 'DỮ LIỆU SỨC KHỎE', style: 'header' }
        ];

        healthRecords.forEach((rec, i) => {
            content.push({
                text: `#${i + 1} - Ngày: ${rec.date}
  Cân nặng: ${rec.weight || 'N/A'} kg
  Huyết áp: ${rec.bloodPressure || 'N/A'}
  Nhịp tim: ${rec.heartRate || 'N/A'} bpm
  Giấc ngủ: ${rec.sleep || 'N/A'} giờ
  Bước chân: ${rec.steps || 'N/A'}
  Ghi chú: ${rec.notes || 'Không có'}\n\n`,
                style: 'normal'
            });
        });

        // 3. Thêm biểu đồ (nếu có hiển thị trên web)
        const charts = [
            { id: "weightChart", title: "Biểu đồ Cân nặng" },
            { id: "bpChart", title: "Biểu đồ Huyết áp" },
            { id: "heartRateChart", title: "Biểu đồ Nhịp tim" },
            { id: "sleepChart", title: "Biểu đồ Giấc ngủ" },
            { id: "stepsChart", title: "Biểu đồ Bước chân" }
        ];

        for (const chart of charts) {
            const canvas = document.getElementById(chart.id);
            if (canvas) {
                const imgData = canvas.toDataURL("image/png");
                content.push({ text: chart.title, style: "header" });
                content.push({ image: imgData, width: 500, margin: [0, 10, 0, 20] });
            }
        }

        // 4. Định nghĩa PDF
        const docDefinition = {
            content: content,
            styles: {
                header: { fontSize: 16, bold: true, margin: [0, 10, 0, 5] },
                subheader: { fontSize: 12, margin: [0, 5, 0, 5] },
                normal: { fontSize: 11 }
            },
            defaultStyle: {
                font: 'Roboto' // pdfmake có Roboto hỗ trợ Unicode
            }
        };

        // 5. Xuất file PDF
        pdfMake.createPdf(docDefinition).download(`profile_${profile.id}.pdf`);
        showMessage("Xuất PDF thành công!");
    } catch (error) {
        console.error("Export PDF failed:", error);
        showMessage("Xuất PDF thất bại.");
    } finally {
        showLoading(false);
    }
}


    </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

</head>
<body class="bg-gray-100 min-h-screen font-sans antialiased text-gray-800">
    <!-- Header chính (chỉ hiển thị khi đã đăng nhập) -->
    <header id="main-header" class="hidden fixed top-0 left-0 w-full bg-indigo-600 text-white shadow-md p-4 z-10">
        <div class="container mx-auto flex items-center justify-between flex-wrap">
            <span id="user-email-display" class="text-lg font-bold mr-4"></span>
            <div class="flex items-center space-x-2 flex-wrap mt-2 sm:mt-0">
                <button id="add-profile-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300">Thêm Hồ Sơ</button>
                <button id="change-password-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-300">Đổi Mật Khẩu</button>
                <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">Đăng Xuất</button>
                <button id="add-user-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300 hidden">Thêm Tài Khoản</button>
            </div>
        </div>
    </header>

    <div class="w-full max-w-7xl mx-auto p-4 md:p-8 mt-16">
        <!-- Biểu mẫu đăng nhập -->
        <div id="login-form" class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-md mx-auto">
            <h2 class="text-4xl font-extrabold text-center text-indigo-600 mb-8">Đăng Nhập</h2>
            <form>
                <div class="mb-5">
                    <label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="login-email" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200 transition" placeholder="example@gmail.com" required>
                </div>
                <div class="mb-8">
                    <label for="login-password" class="block text-gray-700 font-semibold mb-2">Mật khẩu</label>
                    <input type="password" id="login-password" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-200 transition" placeholder="Mật khẩu của bạn" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-lg">Đăng Nhập</button>
                <div id="login-error-msg" class="text-red-500 text-center mt-4 font-medium"></div>
            </form>
        </div>

        <!-- Nội dung chính (sau khi đăng nhập) -->
        <div id="main-content" class="hidden mt-8">
            <h2 class="text-3xl font-bold text-gray-700 mb-6 text-center">Danh sách Hồ sơ</h2>
            <div id="profile-list" class="flex overflow-x-auto gap-6 p-4 -mx-4 pb-6 scrollbar-thin scrollbar-thumb-indigo-500 scrollbar-track-indigo-100">
                <!-- Hồ sơ sẽ được hiển thị ở đây -->
            </div>
        </div>

        <!-- Section nhập liệu sức khỏe -->
        <div id="health-data-section" class="hidden mt-8 p-8 bg-white rounded-xl shadow-2xl w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-bold text-indigo-600">Dữ Liệu Sức Khỏe</h3>
                <button id="close-health-data-btn" class="text-gray-500 hover:text-gray-700 transition duration-300">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Form nhập liệu -->
            <form id="health-data-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="health-date" class="block text-gray-700 font-medium mb-1">Ngày</label>
                    <input type="date" id="health-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition">
                </div>
                <div>
                    <label for="health-weight" class="block text-gray-700 font-medium mb-1">Cân nặng (kg)</label>
                    <input type="number" id="health-weight" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 65">
                </div>
                <div>
                    <label for="health-bp" class="block text-gray-700 font-medium mb-1">Huyết áp</label>
                    <input type="text" id="health-bp" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 120/80">
                </div>
                <div>
                    <label for="health-heart-rate" class="block text-gray-700 font-medium mb-1">Nhịp tim (bpm)</label>
                    <input type="number" id="health-heart-rate" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 75">
                </div>
                <div>
                    <label for="health-sleep" class="block text-gray-700 font-medium mb-1">Giấc ngủ (giờ)</label>
                    <input type="number" id="health-sleep" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 8">
                </div>
                <div>
                    <label for="health-steps" class="block text-gray-700 font-medium mb-1">Bước chân</label>
                    <input type="number" id="health-steps" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., 10000">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="health-note" class="block text-gray-700 font-medium mb-1">Ghi chú</label>
                    <textarea id="health-note" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Thêm ghi chú..."></textarea>
                </div>
                <div class="col-span-1 md:col-span-2 flex justify-end mt-4">
                    <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">Lưu</button>
                </div>
            </form>

            <hr class="my-8">
            
            <!-- Danh sách dữ liệu sức khỏe đã lưu -->
            <div id="health-data-list-container" class="h-[30rem] overflow-y-auto pr-4">
                <div id="health-data-list" class="space-y-4">
                    <!-- Dữ liệu sức khỏe sẽ được hiển thị ở đây -->
                </div>
            </div>
            
            <!-- Phần biểu đồ -->
            <div id="charts-section" class="hidden mt-8 p-8 bg-white rounded-xl shadow-2xl">
                <h3 class="text-2xl font-bold text-gray-700 mb-6 text-center">Biểu Đồ Sức Khỏe</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <canvas id="bpChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <canvas id="heartRateChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <canvas id="sleepChart"></canvas>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <canvas id="stepsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Các Modal (pop-up) -->
        <!-- Hộp thoại đổi mật khẩu -->
        <div id="change-password-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-20">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-6">Đổi Mật Khẩu</h3>
                <input type="password" id="new-password-input" class="w-full px-5 py-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nhập mật khẩu mới" required>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-change-password" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">Hủy</button>
                    <button id="confirm-change-password" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Xác Nhận</button>
                </div>
            </div>
        </div>

        <!-- Hộp thoại thêm tài khoản mới -->
        <div id="add-account-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-20">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
                <h3 class="text-2xl font-bold text-center mb-6">Thêm Tài Khoản Mới</h3>
                <input type="email" id="new-email-input" class="w-full px-5 py-3 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Email" required>
                <input type="password" id="new-password-add-input" class="w-full px-5 py-3 border rounded-lg mb-5 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Mật khẩu (ít nhất 6 ký tự)" required>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-add-account" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">Hủy</button>
                    <button id="confirm-add-account" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Thêm</button>
                </div>
            </div>
        </div>

        <!-- Hộp thoại thêm/sửa hồ sơ -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-30">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
                <h3 id="profile-modal-title" class="text-2xl font-bold text-center mb-6"></h3>
                <form id="profile-form">
                    <input type="hidden" id="profile-id">
                    <input type="text" id="profile-name" class="w-full px-5 py-3 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Họ và tên" required>
                    <input type="number" id="profile-age" class="w-full px-5 py-3 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Tuổi" required>
                    <input type="text" id="profile-address" class="w-full px-5 py-3 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nơi ở" required>
                    <textarea id="profile-note" class="w-full px-5 py-3 border rounded-lg mb-5 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Ghi chú"></textarea>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-profile-btn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">Hủy</button>
                        <button type="submit" id="save-profile-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Lưu Hồ Sơ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Hộp thoại xác nhận xóa hồ sơ -->
        <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-40">
            <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl text-center">
                <p class="text-lg font-semibold text-gray-700 mb-6">Bạn có chắc chắn muốn xóa hồ sơ này không?</p>
                <div class="flex justify-center space-x-3">
                    <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">Hủy</button>
                    <button id="confirm-delete-btn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Xóa</button>
                </div>
            </div>
        </div>

        <!-- Chỉ báo tải toàn cầu -->
        <div id="loading-indicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
        </div>
        
        <!-- Hộp thoại thông báo tùy chỉnh -->
        <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-40">
            <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl text-center">
                <p id="message-content" class="text-lg font-semibold text-gray-700 mb-6"></p>
                <button id="message-close-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-300">Đóng</button>
            </div>
        </div>
    </div>



</body>
</html>
