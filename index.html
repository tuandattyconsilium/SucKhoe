<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Theo dõi sức khỏe — Daily Health Tracker</title>
  <style>
    :root{--accent:#0b8f6e;--muted:#666;--danger:#dc2626}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4;margin:0;padding:16px;background:#f6fbf8;color:#0b2b20}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px}
    h1{font-size:20px;margin:0}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(12,30,20,0.06);margin-top:14px}
    form.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="number"], input[type="text"], input[type="date"], input[type="password"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6efe9;font-size:14px}
    textarea{min-height:60px}
    .row{display:flex;gap:8px}
    button{background:var(--accent);color:#fff;border:0;padding:10px 12px;border-radius:10px;cursor:pointer;transition:background-color 0.2s}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,143,110,0.14)}
    button.danger{background:var(--danger)}
    button:hover{filter:brightness(1.1)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid #f0f3f1;font-size:13px;text-align:left}
    .small{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chart-wrap{height:220px;margin-top:12px;background:#fff;border-radius:10px;padding:10px}
    #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(0,0,0,0.7);
        color: white;
        border-radius: 10px;
        display: none;
        z-index: 1000;
        text-align: center;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
    }
    #auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        height: 80vh;
        gap: 16px;
    }
    .tab-container {
      display: flex;
      justify-content: center;
      margin-bottom: 12px;
      border-bottom: 1px solid #e6efe9;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 16px;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-bottom-color 0.2s;
    }
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .form-section {
      display: none;
    }
    .form-section.active {
      display: block;
    }
    .alert-message {
      color: var(--danger);
      font-size: 14px;
      margin-top: 10px;
    }
    @media (max-width:520px){header{flex-direction:column;align-items:flex-start} .chart-wrap{height:200px}}
  </style>
</head>
<body>
  
  <!-- Container Đăng nhập -->
  <div id="auth-container">
    <div class="card" style="width: 100%; max-width: 400px; padding: 20px">
        <h2 style="margin: 0; text-align: center;">Đăng nhập</h2>
        <div class="form-section active" id="loginFormSection">
            <form id="loginForm">
                <label>Email</label>
                <input type="email" id="loginEmail" required>
                <div style="height: 12px;"></div>
                <label>Mật khẩu</label>
                <input type="password" id="loginPassword" required>
                <div style="height: 16px;"></div>
                <button type="submit" style="width: 100%">Đăng nhập</button>
            </form>
        </div>
        <p class="alert-message" id="authErrorMsg"></p>
    </div>
  </div>

  <!-- Container Ứng dụng chính -->
  <div class="wrap" id="app-container" style="display: none;">
    <header>
      <div>
        <h1>Theo dõi & chăm sóc sức khoẻ hằng ngày</h1>
        <p class="small">Ghi lại nhanh các chỉ số: cân nặng, huyết áp, nhịp tim, giấc ngủ, bước chân.</p>
        <div id="admin-view-controls" style="display: none; margin-top: 8px;">
            <label for="user-select" class="small">Chọn người dùng để xem:</label>
            <select id="user-select" style="width: auto; min-width: 200px;"></select>
            <p class="small">Hồ sơ của: <b id="viewed-user-name">N/A</b> | Tuổi: <b id="viewed-user-age">N/A</b> | Nơi ở: <b id="viewed-user-location">N/A</b></p>
        </div>
        <p class="small">ID người dùng hiện tại: <b id="user-id-display"></b></p>
      </div>
      <div class="controls">
        <button id="addAccountBtn" style="display: none;">Thêm tài khoản</button>
        <button id="changePasswordBtn">Đổi mật khẩu</button>
        <button id="exportBtn">Xuất CSV</button>
        <button id="clearBtn" class="ghost">Xoá toàn bộ</button>
        <label for="importFile" class="ghost" style="padding:8px 12px;border-radius:10px;cursor:pointer">Nhập CSV
          <input id="importFile" type="file" accept="text/csv" style="display:none">
        </label>
        <button id="logoutBtn" class="danger">Đăng xuất</button>
      </div>
    </header>
    
    <section class="card" id="profileFormCard" style="display: none;">
        <h3 style="margin-top:0">Cập nhật hồ sơ</h3>
        <form id="profileForm" class="grid" autocomplete="off">
            <div>
                <label>Họ và tên</label>
                <input type="text" id="name" placeholder="Họ và tên">
            </div>
            <div>
                <label>Tuổi</label>
                <input type="number" id="age" placeholder="Tuổi">
            </div>
            <div>
                <label>Nơi ở</label>
                <input type="text" id="location" placeholder="Tỉnh/Thành phố">
            </div>
            <div style="grid-column:1/-1;text-align:right">
                <button type="submit">Lưu hồ sơ</button>
            </div>
        </form>
    </section>

    <section class="card" id="entryFormCard">
      <form id="entryForm" class="grid" autocomplete="off">
        <div>
          <label>Ngày</label>
          <input type="date" id="date" required>
        </div>
        <div>
          <label>Cân nặng (kg)</label>
          <input type="number" step="0.1" id="weight" placeholder="ví dụ 68.5">
        </div>
        <div>
          <label>Huyết áp (tâm thu / tâm trương)</label>
          <div class="row">
            <input type="number" id="bp_s" placeholder="120">
            <input type="number" id="bp_d" placeholder="80">
          </div>
        </div>
        <div>
          <label>Nhịp tim (bpm)</label>
          <input type="number" id="hr" placeholder="70">
        </div>
        <div>
          <label>Giấc ngủ (giờ)</label>
          <input type="number" step="0.1" id="sleep" placeholder="7.5">
        </div>
        <div>
          <label>Bước chân</label>
          <input type="number" id="steps" placeholder="5000">
        </div>
        <div style="grid-column:1/-1">
          <label>Ghi chú</label>
          <textarea id="notes" placeholder="Cảm giác, thuốc đã dùng, tập luyện..."></textarea>
        </div>

        <div style="grid-column:1/-1;text-align:right">
          <button type="submit">Lưu</button>
        </div>
      </form>
    </section>
    
    <div class="modal" id="myModal">
      <div class="modal-content">
        <p id="modalMessage"></p>
        <div style="height: 10px;"></div>
        <button id="modalOkBtn">Đóng</button>
      </div>
    </div>
    
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            <h3 style="margin-top:0">Thêm tài khoản mới</h3>
            <form id="addAccountForm">
                <label>Email</label>
                <input type="email" id="newEmail" required>
                <div style="height: 12px;"></div>
                <label>Mật khẩu</label>
                <input type="password" id="newPassword" required>
                <div style="height: 12px;"></div>
                <button type="submit">Tạo tài khoản</button>
                <p class="alert-message" id="addAccountErrorMsg"></p>
            </form>
            <div style="height: 10px;"></div>
            <button id="closeAddAccountModal" class="ghost">Đóng</button>
        </div>
    </div>
    
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <h3 style="margin-top:0">Đổi mật khẩu</h3>
            <form id="changePasswordForm">
                <label>Mật khẩu mới</label>
                <input type="password" id="newPassword" required>
                <div style="height: 12px;"></div>
                <button type="submit">Đổi mật khẩu</button>
                <p class="alert-message" id="changePasswordErrorMsg"></p>
            </form>
            <div style="height: 10px;"></div>
            <button id="closeChangePasswordModal" class="ghost">Đóng</button>
        </div>
    </div>

    <div id="loading" style="display: none;">Đang xử lý...</div>

    <section class="card" id="historyCard">
      <h3 style="margin:0 0 8px 0">Lịch sử</h3>
      <div style="overflow:auto;max-height:400px">
        <table id="healthTable">
          <thead>
            <tr>
              <th>Ngày</th>
              <th>Cân nặng</th>
              <th>Huyết áp</th>
              <th>Nhịp tim</th>
              <th>Giấc ngủ</th>
              <th>Bước chân</th>
              <th>Ghi chú</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </section>
    
    <section class="card" id="chartCard">
        <h3 style="margin:0 0 8px 0">Biểu đồ</h3>
        <div class="chart-wrap">
            <canvas id="healthChart"></canvas>
        </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    // Firebase: Thêm các module Auth cần thiết
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, getDocs, query, orderBy, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    const firebaseConfig = {
      apiKey: "AIzaSyDGJOZMUz2ITGwsXMQAeGU2KeZi0njShvg",
      authDomain: "suckhoeuutienso1.firebaseapp.com",
      projectId: "suckhoeuutienso1",
      storageBucket: "suckhoeuutienso1.firebasestorage.app",
      messagingSenderId: "838493203134",
      appId: "1:838493203134:web:4064d659ea5409ae780cef",
      measurementId: "G-G51BKKHGL3"
    };

    // Khởi tạo Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Globals
    let data = [];
    let myChart = null;
    let isAdmin = false;
    let currentAdminViewUid = null;

    // Elements
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('loginForm');
    const authErrorMsg = document.getElementById('authErrorMsg');
    const logoutBtn = document.getElementById('logoutBtn');
    const changePasswordBtn = document.getElementById('changePasswordBtn');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const exportBtn = document.getElementById('exportBtn');
    const clearBtn = document.getElementById('clearBtn');
    const importFile = document.getElementById('importFile');
    const userDisplay = document.getElementById('user-id-display');
    const profileFormCard = document.getElementById('profileFormCard');
    const entryFormCard = document.getElementById('entryFormCard');
    const healthTableBody = document.querySelector('#healthTable tbody');
    const loadingIndicator = document.getElementById('loading');
    const modal = document.getElementById('myModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalOkBtn = document.getElementById('modalOkBtn');
    const saveButton = entryForm.querySelector('button[type="submit"]');

    // Admin-specific elements
    const adminViewControls = document.getElementById('admin-view-controls');
    const userSelect = document.getElementById('user-select');
    const viewedUserName = document.getElementById('viewed-user-name');
    const viewedUserAge = document.getElementById('viewed-user-age');
    const viewedUserLocation = document.getElementById('viewed-user-location');

    // Modals
    const addAccountModal = document.getElementById('addAccountModal');
    const addAccountForm = document.getElementById('addAccountForm');
    const addAccountErrorMsg = document.getElementById('addAccountErrorMsg');
    const closeAddAccountModal = document.getElementById('closeAddAccountModal');
    
    const changePasswordModal = document.getElementById('changePasswordModal');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const changePasswordErrorMsg = document.getElementById('changePasswordErrorMsg');
    const closeChangePasswordModal = document.getElementById('closeChangePasswordModal');

    // Hàm hiển thị modal thông báo
    function showModal(message) {
      modalMessage.textContent = message;
      modal.style.display = 'flex';
    }
    modalOkBtn.onclick = () => { modal.style.display = 'none'; };

    // Hàm hiển thị modal thêm tài khoản
    addAccountBtn.addEventListener('click', () => {
        addAccountModal.style.display = 'flex';
        addAccountErrorMsg.textContent = '';
    });
    closeAddAccountModal.addEventListener('click', () => {
        addAccountModal.style.display = 'none';
        addAccountForm.reset();
    });
    
    // Hàm hiển thị modal đổi mật khẩu
    changePasswordBtn.addEventListener('click', () => {
        changePasswordModal.style.display = 'flex';
        changePasswordErrorMsg.textContent = '';
    });
    closeChangePasswordModal.addEventListener('click', () => {
        changePasswordModal.style.display = 'none';
        changePasswordForm.reset();
    });

    // Hàm hiển thị loading
    function showLoading(show) {
      loadingIndicator.style.display = show ? 'block' : 'none';
      saveButton.disabled = show;
      logoutBtn.disabled = show;
      exportBtn.disabled = show;
      clearBtn.disabled = show;
      importFile.disabled = show;
      changePasswordBtn.disabled = show;
      if (isAdmin) {
          addAccountBtn.disabled = show;
      }
    }

    // Lấy collection path dựa trên user ID
    function getCollectionPath(uid) {
        return `users/${uid}/health_entries`;
    }

    // Lắng nghe trạng thái xác thực
    onAuthStateChanged(auth, async (user) => {
        showLoading(true);
        if (user) {
            // Người dùng đã đăng nhập
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
            userDisplay.textContent = user.uid;
            
            // Kiểm tra role admin dựa trên email
            isAdmin = user.email === 'admin@myapp.com';
            addAccountBtn.style.display = isAdmin ? 'block' : 'none';
            adminViewControls.style.display = isAdmin ? 'block' : 'none';
            entryFormCard.style.display = isAdmin ? 'none' : 'block';

            if (isAdmin) {
                await fetchAndPopulateUsers(user.uid);
            } else {
                currentAdminViewUid = user.uid;
                await updateProfileDisplay(currentAdminViewUid);
                // Bắt đầu lắng nghe dữ liệu cho người dùng hiện tại
                startFirestoreListener(getCollectionPath(currentAdminViewUid));
            }

        } else {
            // Người dùng đã đăng xuất
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            userDisplay.textContent = 'N/A';
            viewedUserName.textContent = 'N/A';
            viewedUserAge.textContent = 'N/A';
            viewedUserLocation.textContent = 'N/A';
            data = [];
            renderTable();
            if (myChart) {
                myChart.destroy();
                myChart = null;
            }
            currentAdminViewUid = null;
            isAdmin = false;
        }
        showLoading(false);
    });

    // Cập nhật thông tin hồ sơ được xem
    async function updateProfileDisplay(uid) {
        const profileDoc = await getDoc(doc(db, "users", uid));
        if (profileDoc.exists()) {
            const profileData = profileDoc.data();
            viewedUserName.textContent = profileData.name || "N/A";
            viewedUserAge.textContent = profileData.age || "N/A";
            viewedUserLocation.textContent = profileData.location || "N/A";
        } else {
            viewedUserName.textContent = "N/A";
            viewedUserAge.textContent = "N/A";
            viewedUserLocation.textContent = "N/A";
        }
        // Admin chỉ xem, không chỉnh sửa hồ sơ người khác
        profileFormCard.style.display = isAdmin ? 'none' : 'block';
    }

    // Lấy danh sách tất cả người dùng và điền vào dropdown (chỉ admin)
    async function fetchAndPopulateUsers(adminUid) {
        userSelect.innerHTML = '';
        const usersRef = collection(db, "users");
        const usersSnap = await getDocs(usersRef);
        
        let allUsers = [];
        usersSnap.forEach(doc => {
            allUsers.push({ id: doc.id, email: doc.data().email, name: doc.data().name });
        });
        
        // Add all users to the dropdown
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name ? `${user.name} (${user.email || user.id})` : (user.email || user.id);
            userSelect.appendChild(option);
        });

        // Add the admin's own account to the dropdown
        const adminUserDoc = await getDoc(doc(db, 'users', adminUid));
        const adminEmail = adminUserDoc.exists() ? adminUserDoc.data().email : 'admin@myapp.com';
        const adminOption = document.createElement('option');
        adminOption.value = adminUid;
        adminOption.textContent = `Hồ sơ của tôi (${adminEmail})`;
        userSelect.prepend(adminOption);

        // Set the default selection to the admin's own UID
        userSelect.value = adminUid;
        currentAdminViewUid = adminUid;

        // Start listening to the selected user's data
        await updateProfileDisplay(currentAdminViewUid);
        startFirestoreListener(getCollectionPath(currentAdminViewUid));

        // Event listener for dropdown change
        userSelect.addEventListener('change', (e) => {
            currentAdminViewUid = e.target.value;
            showLoading(true);
            updateProfileDisplay(currentAdminViewUid);
            startFirestoreListener(getCollectionPath(currentAdminViewUid));
        });
    }

    // Lưu hồ sơ (chỉ cho người dùng thường)
    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const user = auth.currentUser;
        if (!user || isAdmin) { // Block admin from using this form
            showModal("Bạn không có quyền lưu dữ liệu hồ sơ này.");
            showLoading(false);
            return;
        }

        const profile = {
            name: document.getElementById('name').value,
            age: document.getElementById('age').value,
            location: document.getElementById('location').value,
            timestamp: new Date()
        };

        try {
            await setDoc(doc(db, "users", user.uid), profile, { merge: true });
            showModal("Hồ sơ đã được lưu thành công!");
            profileFormCard.style.display = 'none';
        } catch (error) {
            console.error("Lỗi khi lưu hồ sơ: ", error);
            showModal("Lỗi khi lưu hồ sơ. Vui lòng thử lại.");
        } finally {
            showLoading(false);
        }
    });

    // Lắng nghe realtime từ Firestore
    function startFirestoreListener(collectionPath) {
      if (!collectionPath) return;
      const colRef = collection(db, collectionPath);
      const q = query(colRef, orderBy('date'));
      onSnapshot(q, (snapshot) => {
        showLoading(true);
        const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        data = docs.sort((a, b) => new Date(a.date) - new Date(b.date));
        renderTable();
        renderChart();
        showLoading(false);
      }, (error) => {
        console.error("Lỗi khi lắng nghe Firestore: ", error);
        showModal("Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại.");
        showLoading(false);
      });
    }

    // Render bảng
    function renderTable() {
      healthTableBody.innerHTML = '';
      if (data.length === 0) {
        healthTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Chưa có dữ liệu nào được lưu.</td></tr>';
        return;
      }
      data.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry.date}</td>
          <td>${entry.weight || '-'} kg</td>
          <td>${entry.bp_s || '-'}/${entry.bp_d || '-'}</td>
          <td>${entry.hr || '-'} bpm</td>
          <td>${entry.sleep || '-'} giờ</td>
          <td>${entry.steps || '-'}</td>
          <td>${entry.notes || '-'}</td>
          <td>
            <button class="ghost delete-btn" data-id="${entry.id}">Xóa</button>
          </td>
        `;
        healthTableBody.appendChild(row);
      });

      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', handleDelete);
      });
    }

    // Render chart
    function renderChart() {
      const dates = data.map(entry => entry.date);
      const weights = data.map(entry => entry.weight);
      const bp_s = data.map(entry => entry.bp_s);
      const bp_d = data.map(entry => entry.bp_d);
      const hrs = data.map(entry => entry.hr);
      const sleep = data.map(entry => entry.sleep);
      const steps = data.map(entry => entry.steps);

      const ctx = document.getElementById('healthChart').getContext('2d');
      if (myChart) {
        myChart.destroy();
      }
      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Cân nặng (kg)',
            data: weights,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            fill: false,
            tension: 0.1
          }, {
            label: 'Huyết áp Tâm thu',
            data: bp_s,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            fill: false,
            tension: 0.1
          }, {
            label: 'Huyết áp Tâm trương',
            data: bp_d,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: false,
            tension: 0.1
          }, {
            label: 'Nhịp tim (bpm)',
            data: hrs,
            borderColor: 'rgba(153, 102, 255, 1)',
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            fill: false,
            tension: 0.1
          }, {
            label: 'Giấc ngủ (giờ)',
            data: sleep,
            borderColor: 'rgba(255, 159, 64, 1)',
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            fill: false,
            tension: 0.1
          }, {
            label: 'Bước chân',
            data: steps,
            borderColor: 'rgba(255, 205, 86, 1)',
            backgroundColor: 'rgba(255, 205, 86, 0.2)',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Ngày'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Giá trị'
              }
            }
          }
        }
      });
    }

    // Đăng nhập
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            // Lưu email vào profile
            await setDoc(doc(db, "users", userCredential.user.uid), { email: email }, { merge: true });
            authErrorMsg.textContent = '';
        } catch (error) {
            console.error(error);
            authErrorMsg.textContent = "Đăng nhập thất bại. Vui lòng kiểm tra lại email/mật khẩu.";
        } finally {
            showLoading(false);
        }
    });
    
    // Thêm tài khoản (chỉ admin)
    addAccountForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const email = document.getElementById('newEmail').value;
        const password = document.getElementById('newPassword').value;
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            // Lưu email vào profile của người dùng mới tạo
            await setDoc(doc(db, "users", userCredential.user.uid), { email: email }, { merge: true });
            showModal(`Đã tạo tài khoản mới: ${email}`);
            addAccountModal.style.display = 'none';
            addAccountForm.reset();
        } catch (error) {
            console.error(error);
            addAccountErrorMsg.textContent = "Lỗi khi tạo tài khoản. Email có thể đã tồn tại hoặc mật khẩu quá yếu.";
        } finally {
            showLoading(false);
        }
    });
    
    // Đổi mật khẩu
    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading(true);
        const user = auth.currentUser;
        const newPassword = document.getElementById('newPassword').value;
        if (user) {
            try {
                await updatePassword(user, newPassword);
                showModal("Mật khẩu đã được đổi thành công!");
                changePasswordModal.style.display = 'none';
                changePasswordForm.reset();
            } catch (error) {
                console.error(error);
                changePasswordErrorMsg.textContent = "Lỗi khi đổi mật khẩu. Vui lòng thử lại sau.";
            } finally {
                showLoading(false);
            }
        }
    });

    // Đăng xuất
    logoutBtn.addEventListener('click', async () => {
        showLoading(true);
        try {
            await signOut(auth);
            showModal("Bạn đã đăng xuất thành công.");
        } catch (error) {
            console.error(error);
            showModal("Lỗi khi đăng xuất.");
        } finally {
            showLoading(false);
        }
    });

    // Submit form: lưu vào collection
    entryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoading(true);
      const user = auth.currentUser;
      if (!user) {
          showModal("Bạn cần đăng nhập để lưu dữ liệu.");
          showLoading(false);
          return;
      }
      const entry = {
        date: document.getElementById('date').value,
        weight: parseFloat(document.getElementById('weight').value) || null,
        bp_s: parseInt(document.getElementById('bp_s').value) || null,
        bp_d: parseInt(document.getElementById('bp_d').value) || null,
        hr: parseInt(document.getElementById('hr').value) || null,
        sleep: parseFloat(document.getElementById('sleep').value) || null,
        steps: parseInt(document.getElementById('steps').value) || null,
        notes: document.getElementById('notes').value || null,
        timestamp: new Date()
      };

      try {
        await addDoc(collection(db, getCollectionPath(user.uid)), entry);
        showModal("Dữ liệu đã được lưu thành công!");
        entryForm.reset();
      } catch (error) {
        console.error("Lỗi khi thêm tài liệu: ", error);
        showModal("Lỗi khi lưu dữ liệu. Vui lòng thử lại.");
      } finally {
        showLoading(false);
      }
    });

    // Xóa 1 document
    async function handleDelete(e) {
      showLoading(true);
      const docId = e.target.getAttribute('data-id');
      const userUid = auth.currentUser.uid;
      const targetUid = isAdmin ? currentAdminViewUid : userUid;
      if (!targetUid || !docId) {
          showLoading(false);
          return;
      }
      try {
        await deleteDoc(doc(db, getCollectionPath(targetUid), docId));
        showModal("Dữ liệu đã được xóa thành công!");
      } catch (error) {
        console.error("Lỗi khi xóa tài liệu: ", error);
        showModal("Lỗi khi xóa dữ liệu. Vui lòng thử lại.");
      } finally {
        showLoading(false);
      }
    }

    // Xuất CSV (header tiếng Việt)
    exportBtn.addEventListener('click', () => {
        const userUid = auth.currentUser.uid;
        const targetUid = isAdmin ? currentAdminViewUid : userUid;
        if (!targetUid) {
            showModal("Bạn cần đăng nhập để xuất dữ liệu.");
            return;
        }
        showLoading(true);
        const headersMap = {
            date: "Ngày",
            weight: "Cân nặng (kg)",
            bp_s: "Huyết áp (tâm thu)",
            bp_d: "Huyết áp (tâm trương)",
            hr: "Nhịp tim (bpm)",
            sleep: "Giấc ngủ (giờ)",
            steps: "Bước chân",
            notes: "Ghi chú"
        };
        const keys = Object.keys(headersMap);
        const csvRows = [];
        csvRows.push(keys.map(k => `"${headersMap[k]}"`).join(','));
        data.forEach(entry => {
            const values = keys.map(k => {
                const value = entry[k] !== undefined && entry[k] !== null ? entry[k] : '';
                return `"${String(value).replace(/"/g, '""')}"`;
            });
            csvRows.push(values.join(','));
        });
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'suc_khoe.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showLoading(false);
    });

    // Xoá toàn bộ
    clearBtn.addEventListener('click', async () => {
        const userUid = auth.currentUser.uid;
        const targetUid = isAdmin ? currentAdminViewUid : userUid;
        if (!targetUid) {
            showModal("Bạn cần đăng nhập để xóa dữ liệu.");
            return;
        }
        showLoading(true);
        try {
            const col = collection(db, getCollectionPath(targetUid));
            const snap = await getDocs(col);
            const deletes = [];
            snap.forEach(d => {
                deletes.push(deleteDoc(doc(db, getCollectionPath(targetUid), d.id)));
            });
            await Promise.all(deletes);
            showModal("Đã xóa tất cả dữ liệu thành công!");
        } catch (error) {
            console.error("Lỗi khi xóa tất cả dữ liệu: ", error);
            showModal("Lỗi khi xóa dữ liệu. Vui lòng thử lại.");
        } finally {
            showLoading(false);
        }
    });

    // Nhập CSV
    importFile.addEventListener('change', (event) => {
        const userUid = auth.currentUser.uid;
        const targetUid = isAdmin ? currentAdminViewUid : userUid;
        if (!targetUid) {
            showModal("Bạn cần đăng nhập để nhập dữ liệu.");
            return;
        }
        const file = event.target.files[0];
        if (file) {
            showLoading(true);
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').map(row => row.trim()).filter(row => row.length > 0);
                if (rows.length > 1) {
                    const headers = rows[0].split(',').map(h => h.replace(/"/g, ''));
                    const headersMap = {
                      "Ngày": "date", "Cân nặng (kg)": "weight", "Huyết áp (tâm thu)": "bp_s",
                      "Huyết áp (tâm trương)": "bp_d", "Nhịp tim (bpm)": "hr",
                      "Giấc ngủ (giờ)": "sleep", "Bước chân": "steps", "Ghi chú": "notes"
                    };
                    const importPromises = [];
                    for (let i = 1; i < rows.length; i++) {
                        const rowValues = rows[i].split(',').map(v => v.replace(/"/g, ''));
                        const newEntry = {};
                        headers.forEach((header, index) => {
                            const key = headersMap[header.trim()];
                            if (key) {
                                let value = rowValues[index] || null;
                                // Convert to correct data types
                                if (['weight', 'sleep'].includes(key) && value) value = parseFloat(value);
                                else if (['bp_s', 'bp_d', 'hr', 'steps'].includes(key) && value) value = parseInt(value);
                                newEntry[key] = value;
                            }
                        });
                        importPromises.push(addDoc(collection(db, getCollectionPath(targetUid)), newEntry));
                    }
                    try {
                        await Promise.all(importPromises);
                        showModal("Dữ liệu đã được nhập thành công!");
                    } catch (error) {
                        console.error("Lỗi khi nhập dữ liệu: ", error);
                        showModal("Lỗi khi nhập dữ liệu. Vui lòng thử lại.");
                    }
                }
                showLoading(false);
            };
            reader.readAsText(file);
        }
    });
  </script>
</body>
</html>
